
SUBROUTINE CUFLXN_SINGLE_COLUMN (YDTHF, YDCST, YDEPHLI, YDECUMF, KIDIA, KFDIA, KLON, KLEV, PTSPHY,&
& PTEN, PQEN, PQSEN, PTENH, PQENH, PAPH, PAP, PGEOH, LDLAND, LDCUM, LDTDKMF, KCBOT, KCTOP, KDTOP, KTOPM2&
&, KTYPE, LDDRAF, PMFU, PMFD, PMFUS, PMFDS, PMFUQ, PMFDQ, PMFUL, PLUDE, PLUDELI, PLRAIN, PSNDE, PDMFUP&
&, PDMFDP, PDPMEL, PLGLAC, PMFLXR, PMFLXS, PRAIN, PMFUDE_RATE, PMFDDE_RATE, YDSTACK)
!$acc routine (CUFLXN_SINGLE_COLUMN) seq
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOETHF,ONLY:TTHF
USE YOEPHLI,ONLY:TEPHLI
USE YOECUMF,ONLY:TECUMF
USE STACK_MOD
#include "stack.h"

IMPLICIT NONE

TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TCST), INTENT (IN)::YDCST
TYPE (TECUMF), INTENT (IN)::YDECUMF
TYPE (TEPHLI), INTENT (IN)::YDEPHLI
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
REAL (KIND=JPRB), INTENT (IN)::PTSPHY
REAL (KIND=JPRB), INTENT (IN)::PTEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PQSEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PTENH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQENH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGEOH (KLON, KLEV+1)
LOGICAL, INTENT (IN)::LDLAND (KLON)
LOGICAL, INTENT (IN)::LDCUM (KLON)
LOGICAL, INTENT (IN)::LDTDKMF
INTEGER (KIND=JPIM), INTENT (IN)::KCBOT (KLON)
INTEGER (KIND=JPIM), INTENT (IN)::KCTOP (KLON)
INTEGER (KIND=JPIM), INTENT (IN)::KDTOP (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KTOPM2
INTEGER (KIND=JPIM), INTENT (INOUT)::KTYPE (KLON)
LOGICAL, INTENT (INOUT)::LDDRAF (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PMFU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PMFD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PMFUS (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PMFDS (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PMFUQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PMFDQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PMFUL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLUDE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLUDELI (KLON, KLEV, 2)
REAL (KIND=JPRB), INTENT (IN)::PLRAIN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PSNDE (KLON, KLEV, 2)
REAL (KIND=JPRB), INTENT (INOUT)::PDMFUP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PDMFDP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PDPMEL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PLGLAC (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFLXR (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PMFLXS (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PRAIN (KLON)
REAL (KIND=JPRB), INTENT (IN)::PMFUDE_RATE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PMFDDE_RATE (KLON, KLEV)
TYPE(STACK) :: YDSTACK
TYPE(STACK) :: YLSTACK

REAL (KIND=JPRB)::ZRCUCOV 
REAL (KIND=JPRB)::ZMFS 
REAL (KIND=JPRB)::ZRHEBC 

INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::IKB
INTEGER (KIND=JPIM)::IK
INTEGER (KIND=JPIM)::IDBAS 
LOGICAL::LLDDRAF

REAL (KIND=JPRB)::ZRHM
REAL (KIND=JPRB)::ZMFMAX
REAL (KIND=JPRB)::ZGLAC
REAL (KIND=JPRB)::ZTEN
REAL (KIND=JPRB)::ZWETB
REAL (KIND=JPRB)::ZTWETB
REAL (KIND=JPRB)::ZZP
REAL (KIND=JPRB)::ZTMST
REAL (KIND=JPRB)::ZTARG
REAL (KIND=JPRB)::ZSNMLT
REAL (KIND=JPRB)::ZRNEW
REAL (KIND=JPRB)::ZRMIN
REAL (KIND=JPRB)::ZRFLN
REAL (KIND=JPRB)::ZRFL
REAL (KIND=JPRB)::ZPDS
REAL (KIND=JPRB)::ZPDR
REAL (KIND=JPRB)::ZOELHM
REAL (KIND=JPRB)::ZOEEWM
REAL (KIND=JPRB)::ZOEALFA
REAL (KIND=JPRB)::ZFOEEWL
REAL (KIND=JPRB)::ZFOEEWI
REAL (KIND=JPRB)::ZFAC
REAL (KIND=JPRB)::ZDRFL1
REAL (KIND=JPRB)::ZDRFL
REAL (KIND=JPRB)::ZDENOM
REAL (KIND=JPRB)::ZCONS2
REAL (KIND=JPRB)::ZCONS1A
REAL (KIND=JPRB)::ZCONS1
REAL (KIND=JPRB)::ZALFAW
REAL (KIND=JPRB), PARAMETER::ZTW1=1329.31_JPRB
REAL (KIND=JPRB), PARAMETER::ZTW2=0.0074615_JPRB
REAL (KIND=JPRB), PARAMETER::ZTW3=0.85E5_JPRB
REAL (KIND=JPRB), PARAMETER::ZTW4=40.637_JPRB
REAL (KIND=JPRB), PARAMETER::ZTW5=275.0_JPRB

#include "fcttre.func.h"

YLSTACK = YDSTACK




JLON = KIDIA


ZTMST=PTSPHY
ZCONS1A=YDCST%RCPD/(YDCST%RLMLT*YDCST%RG*YDECUMF%RTAUMEL)
ZCONS2=YDECUMF%RMFCFL/(YDCST%RG*ZTMST)

IF (YDECUMF%LMFWETB) THEN
  ZWETB=1.0_JPRB
ELSE
  ZWETB=0.0_JPRB
ENDIF


IF (YDECUMF%LMFGLAC) THEN
  ZGLAC=0.0_JPRB
ELSE
  ZGLAC=1.0_JPRB
ENDIF


PRAIN (JLON)=0.0_JPRB

IF (.NOT.LDCUM (JLON).OR.KDTOP (JLON)<KCTOP (JLON))  THEN
    LDDRAF (JLON)=.FALSE.
ENDIF


IF (.NOT.LDCUM (JLON))  THEN
    KTYPE (JLON)=0
ENDIF

IDBAS =KLEV

IF (LDLAND (JLON)) THEN
  ZRHEBC =0.7_JPRB
ELSE
  ZRHEBC =YDECUMF%RHEBC
ENDIF


KTOPM2=2

DO JK=KTOPM2, KLEV
  IKB=MIN (JK+1, KLEV)
  
  PMFLXR (JLON, JK)=0.0_JPRB
  PMFLXS (JLON, JK)=0.0_JPRB
  PDPMEL (JLON, JK)=0.0_JPRB
  PSNDE (JLON, JK, 1)=0.0_JPRB
  PSNDE (JLON, JK, 2)=0.0_JPRB

  IF (LDCUM (JLON).AND.JK>=KCTOP (JLON)) THEN
    PMFUS (JLON, JK)=PMFUS (JLON, JK)-PMFU (JLON, JK)*(YDCST%RCPD*PTENH (JLON, JK)+PGEOH (JLON, JK))
    PMFUQ (JLON, JK)=PMFUQ (JLON, JK)-PMFU (JLON, JK)*PQENH (JLON, JK)
    PLGLAC (JLON, JK)=PMFU (JLON, JK)*PLGLAC (JLON, JK)
    LLDDRAF=LDDRAF (JLON).AND.JK>=KDTOP (JLON)

    IF (LLDDRAF) THEN
      PMFDS (JLON, JK)=PMFDS (JLON, JK)-PMFD (JLON, JK)*(YDCST%RCPD*PTENH (JLON, JK)+PGEOH (JLON, JK))
      PMFDQ (JLON, JK)=PMFDQ (JLON, JK)-PMFD (JLON, JK)*PQENH (JLON, JK)
    ELSE
      PMFD (JLON, JK)=0.0_JPRB
      PMFDS (JLON, JK)=0.0_JPRB
      PMFDQ (JLON, JK)=0.0_JPRB
      PDMFDP (JLON, JK-1)=0.0_JPRB
    ENDIF


    IF (LLDDRAF.AND.PMFD (JLON, JK)<0._JPRB.AND.PMFD (JLON, IKB)==0._JPRB) THEN
      IDBAS =JK
    ENDIF

  ELSE
    PMFU (JLON, JK)=0.0_JPRB
    PMFD (JLON, JK)=0.0_JPRB
    PMFUS (JLON, JK)=0.0_JPRB
    PMFDS (JLON, JK)=0.0_JPRB
    PMFUQ (JLON, JK)=0.0_JPRB
    PMFDQ (JLON, JK)=0.0_JPRB
    PMFUL (JLON, JK)=0.0_JPRB
    PLGLAC (JLON, JK)=0.0_JPRB
    PDMFUP (JLON, JK-1)=0.0_JPRB
    PDMFDP (JLON, JK-1)=0.0_JPRB
    PLUDE (JLON, JK-1)=0.0_JPRB
    PLUDELI (JLON, JK-1, 1)=0.0_JPRB
    PLUDELI (JLON, JK-1, 2)=0.0_JPRB
  ENDIF

  
ENDDO

PMFLXR (JLON, KLEV+1)=0.0_JPRB
PMFLXS (JLON, KLEV+1)=0.0_JPRB
PMFLXR (JLON, 1)=0.0_JPRB
PMFLXS (JLON, 1)=0.0_JPRB
PSNDE (JLON, 1, 1)=0.0_JPRB
PSNDE (JLON, 1, 2)=0.0_JPRB


IF (LDCUM (JLON)) THEN
  IKB=KCBOT (JLON)
  IK=IKB+1
  ZZP=((PAPH (JLON, KLEV+1)-PAPH (JLON, IK))/(PAPH (JLON, KLEV+1)-PAPH (JLON, IKB)))

  IF (KTYPE (JLON)==3)  THEN
      ZZP=ZZP*ZZP
  ENDIF

  PMFU (JLON, IK)=PMFU (JLON, IKB)*ZZP

  IF (YDEPHLI%LPHYLIN) THEN
    ZTARG=PTENH (JLON, IKB)
    ZOEALFA=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB))
    ZOELHM=ZOEALFA*YDCST%RLVTT+(1.0_JPRB-ZOEALFA)*YDCST%RLSTT
    PMFUS (JLON, IK)=(PMFUS (JLON, IKB)-ZOELHM*PMFUL (JLON, IKB))*ZZP
  ELSE
    PMFUS (JLON, IK)=(PMFUS (JLON, IKB)-FOELHMCU (PTENH (JLON, IKB))*PMFUL (JLON, IKB))*ZZP
  ENDIF

  PMFUQ (JLON, IK)=(PMFUQ (JLON, IKB)+PMFUL (JLON, IKB))*ZZP
  PMFUL (JLON, IK)=0.0_JPRB
ENDIF



DO JK=KTOPM2, KLEV

  

  IF (LDCUM (JLON).AND.JK>KCBOT (JLON)+1) THEN
    IKB=KCBOT (JLON)+1
    ZZP=((PAPH (JLON, KLEV+1)-PAPH (JLON, JK))/(PAPH (JLON, KLEV+1)-PAPH (JLON, IKB)))

    IF (KTYPE (JLON)==3)  THEN
        ZZP=ZZP*ZZP
    ENDIF

    PMFU (JLON, JK)=PMFU (JLON, IKB)*ZZP
    PMFUS (JLON, JK)=PMFUS (JLON, IKB)*ZZP
    PMFUQ (JLON, JK)=PMFUQ (JLON, IKB)*ZZP
    PMFUL (JLON, JK)=0.0_JPRB
  ENDIF

  IK=IDBAS 
  LLDDRAF=LDDRAF (JLON).AND.JK>IK.AND.IK<KLEV

  IF (LLDDRAF.AND.IK==KCBOT (JLON)+1) THEN
    ZZP=((PAPH (JLON, KLEV+1)-PAPH (JLON, JK))/(PAPH (JLON, KLEV+1)-PAPH (JLON, IK)))

    IF (KTYPE (JLON)==3)  THEN
        ZZP=ZZP*ZZP
    ENDIF

    PMFD (JLON, JK)=PMFD (JLON, IK)*ZZP
    PMFDS (JLON, JK)=PMFDS (JLON, IK)*ZZP
    PMFDQ (JLON, JK)=PMFDQ (JLON, IK)*ZZP
    PMFDDE_RATE (JLON, JK)=-(PMFD (JLON, JK-1)-PMFD (JLON, JK))
  ELSEIF (LLDDRAF.AND.IK/=KCBOT (JLON)+1.AND.JK==IK+1) THEN
    PMFDDE_RATE (JLON, JK)=-(PMFD (JLON, JK-1)-PMFD (JLON, JK))
  ENDIF

  
ENDDO

ZMFS =1.0_JPRB

DO JK=2, KLEV

  

  IF (LDDRAF (JLON).AND.JK>=KDTOP (JLON)-1) THEN
    ZMFMAX=ABS (PMFU (JLON, JK))*0.98_JPRB

    IF (PMFD (JLON, JK)+ZMFMAX+1.E-15_JPRB<0.0_JPRB) THEN
      ZMFS =MIN (ZMFS ,-ZMFMAX/PMFD (JLON, JK))
    ENDIF

  ENDIF

  
ENDDO


DO JK=2, KLEV

  

  IF (ZMFS <1.0_JPRB.AND.JK>=KDTOP (JLON)-1) THEN
    PMFD (JLON, JK)=PMFD (JLON, JK)*ZMFS 
    PMFDS (JLON, JK)=PMFDS (JLON, JK)*ZMFS 
    PMFDQ (JLON, JK)=PMFDQ (JLON, JK)*ZMFS 
    PMFDDE_RATE (JLON, JK)=PMFDDE_RATE (JLON, JK)*ZMFS 
    PDMFDP (JLON, JK)=PDMFDP (JLON, JK)*ZMFS 
  ENDIF

  
ENDDO


DO JK=KTOPM2, KLEV

  

  IF (LDCUM (JLON).AND.JK>=KCTOP (JLON)-1) THEN
    PRAIN (JLON)=PRAIN (JLON)+PDMFUP (JLON, JK)
    ZTWETB=PTEN (JLON, JK)-MAX (0.0_JPRB, PQSEN (JLON, JK)-PQEN (JLON, JK&
    &))*(ZTW1+ZTW2*(PAP (JLON, JK)-ZTW3)-ZTW4*(PTEN (JLON, JK)-ZTW5))
    ZTEN=ZTWETB*ZWETB+(1.0_JPRB-ZWETB)*PTEN (JLON, JK)

    IF (PMFLXS (JLON, JK)>0.0_JPRB.AND.ZTEN>YDCST%RTT) THEN
      ZCONS1=ZCONS1A*(1.0_JPRB+0.5_JPRB*(ZTEN-YDCST%RTT))
      ZFAC=ZCONS1*(PAPH (JLON, JK+1)-PAPH (JLON, JK))
      ZSNMLT=MIN (PMFLXS (JLON, JK), ZFAC*(ZTEN-YDCST%RTT))
      PDPMEL (JLON, JK)=ZSNMLT

      IF (YDEPHLI%LPHYLIN) THEN
        ZTARG=ZTEN-ZSNMLT/ZFAC
        ZOEALFA=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB))
        ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
        ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
        ZOEEWM=ZOEALFA*ZFOEEWL+(1.0_JPRB-ZOEALFA)*ZFOEEWI
        PQSEN (JLON, JK)=ZOEEWM/PAP (JLON, JK)
      ELSE
        PQSEN (JLON, JK)=FOEEWMCU (ZTEN-ZSNMLT/ZFAC)/PAP (JLON, JK)
      ENDIF

    ENDIF


    IF (YDEPHLI%LPHYLIN) THEN
      ZALFAW=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(ZTEN-YDEPHLI%RLPTRC))+1.0_JPRB))
    ELSE
      ZALFAW=FOEALFCU (ZTEN)
    ENDIF


    IF (PTEN (JLON, JK)<=YDCST%RTT.AND.ZALFAW>0.0_JPRB) THEN
      PLGLAC (JLON, JK)=PLGLAC (JLON, JK)+ZGLAC*ZALFAW*PDMFUP (JLON, JK)+ZALFAW*PDMFDP (JLON, JK)
      ZALFAW=0.0_JPRB
    ENDIF


    IF (YDECUMF%LMFDSNOW.AND.JK<=KCBOT (JLON)) THEN
      PSNDE (JLON, JK, 2)=PLRAIN (JLON, JK+1)*PMFUDE_RATE (JLON, JK)
      PSNDE (JLON, JK, 1)=PSNDE (JLON, JK, 2)*ZALFAW
      PSNDE (JLON, JK, 2)=PSNDE (JLON, JK, 2)*(1.0_JPRB-ZALFAW)
      PSNDE (JLON, JK, 1)=MIN (PSNDE (JLON, JK, 1), ZALFAW*(PDMFUP (JLON, JK)+PDMFDP (JLON, JK)))
      PSNDE (JLON, JK, 2)=MIN (PSNDE (JLON, JK, 2),(1.0_JPRB-ZALFAW&
      &)*(PDMFUP (JLON, JK)+PDMFDP (JLON, JK))-PDPMEL (JLON, JK))
      PSNDE (JLON, JK, 1)=MAX (PSNDE (JLON, JK, 1), 0.0_JPRB)
      PSNDE (JLON, JK, 2)=MAX (PSNDE (JLON, JK, 2), 0.0_JPRB)
    ENDIF

    PMFLXR (JLON, JK+1)=PMFLXR (JLON, JK)+ZALFAW*(PDMFUP (JLON, JK&
    &)+PDMFDP (JLON, JK))+PDPMEL (JLON, JK)-PSNDE (JLON, JK, 2)
    PMFLXS (JLON, JK+1)=PMFLXS (JLON, JK)+(1.0_JPRB-ZALFAW)*(PDMFUP (JLON&
    &, JK)+PDMFDP (JLON, JK))-PDPMEL (JLON, JK)-PSNDE (JLON, JK, 1)

    IF (PMFLXR (JLON, JK+1)+PMFLXS (JLON, JK+1)<0.0_JPRB) THEN
      PDMFDP (JLON, JK)=-(PMFLXR (JLON, JK)+PMFLXS (JLON, JK)+PDMFUP (JLON, JK))
      PMFLXR (JLON, JK+1)=0.0_JPRB
      PMFLXS (JLON, JK+1)=0.0_JPRB
      PDPMEL (JLON, JK)=0.0_JPRB
    ELSEIF (PMFLXR (JLON, JK+1)<0.0_JPRB) THEN
      PMFLXS (JLON, JK+1)=PMFLXS (JLON, JK+1)+PMFLXR (JLON, JK+1)
      PMFLXR (JLON, JK+1)=0.0_JPRB
    ELSEIF (PMFLXS (JLON, JK+1)<0.0_JPRB) THEN
      PMFLXR (JLON, JK+1)=PMFLXR (JLON, JK+1)+PMFLXS (JLON, JK+1)
      PMFLXS (JLON, JK+1)=0.0_JPRB
    ENDIF

  ENDIF

  
ENDDO


IF (.NOT.LDTDKMF) THEN

  

  IF (KTYPE (JLON)==2) THEN
    IKB=KCBOT (JLON)
    IK=KCTOP (JLON)
    ZRHM=0.5*(PQEN (JLON, IKB)/PQSEN (JLON, IKB)+PQEN (JLON, IK)/PQSEN (JLON, IK))
    ZRCUCOV =YDECUMF%RCUCOV*(1.0_JPRB+(MAX (0.8_JPRB, ZRHM)-0.8_JPRB)/0.025_JPRB)
  ELSE
    ZRCUCOV =YDECUMF%RCUCOV
  ENDIF

  
ELSE
  
  ZRCUCOV =YDECUMF%RCUCOV
  
ENDIF


DO JK=KTOPM2, KLEV

  

  IF (LDCUM (JLON).AND.JK>=KCBOT (JLON)) THEN
    ZRFL=PMFLXR (JLON, JK)+PMFLXS (JLON, JK)

    IF (ZRFL>1.E-12_JPRB) THEN
      ZDRFL1=YDECUMF%RCPECONS*MAX (0.0_JPRB, PQSEN (JLON, JK)-PQEN (JLON, JK)&
      &)*ZRCUCOV *(SQRT (PAPH (JLON, JK)/PAPH (JLON, KLEV+1))/YDECUMF%RCVRFACTOR&
      &*ZRFL/ZRCUCOV )**0.5777_JPRB*(PAPH (JLON, JK+1)-PAPH (JLON, JK))
      ZRNEW=ZRFL-ZDRFL1
      ZRMIN=ZRFL-ZRCUCOV *MAX (0.0_JPRB, ZRHEBC *PQSEN (JLON, JK)-PQEN&
      & (JLON, JK))*ZCONS2*(PAPH (JLON, JK+1)-PAPH (JLON, JK))
      ZRNEW=MAX (ZRNEW, ZRMIN)
      ZRFLN=MAX (ZRNEW, 0.0_JPRB)
      ZDRFL=MIN (0.0_JPRB, ZRFLN-ZRFL)

      IF (YDEPHLI%LPHYLIN) THEN
        ZALFAW=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(PTEN (JLON, JK)-YDEPHLI%RLPTRC))+1.0_JPRB))
      ELSE
        ZALFAW=FOEALFCU (PTEN (JLON, JK))
      ENDIF


      IF (PTEN (JLON, JK)<YDCST%RTT)  THEN
          ZALFAW=0.0_JPRB
      ENDIF

      ZPDR=ZALFAW*PDMFDP (JLON, JK)
      ZPDS=(1.0_JPRB-ZALFAW)*PDMFDP (JLON, JK)
      ZDENOM=1.0_JPRB/MAX (1.E-12_JPRB, PMFLXR (JLON, JK)+PMFLXS (JLON, JK))
      PMFLXR (JLON, JK+1)=PMFLXR (JLON, JK)+ZPDR+PDPMEL (JLON, JK)+ZDRFL*PMFLXR (JLON, JK)*ZDENOM
      PMFLXS (JLON, JK+1)=PMFLXS (JLON, JK)+ZPDS-PDPMEL (JLON, JK)+ZDRFL*PMFLXS (JLON, JK)*ZDENOM
      PDMFUP (JLON, JK)=PDMFUP (JLON, JK)+ZDRFL

      IF (PMFLXR (JLON, JK+1)+PMFLXS (JLON, JK+1)<0.0_JPRB) THEN
        PDMFUP (JLON, JK)=PDMFUP (JLON, JK)-(PMFLXR (JLON, JK+1)+PMFLXS (JLON, JK+1))
        PMFLXR (JLON, JK+1)=0.0_JPRB
        PMFLXS (JLON, JK+1)=0.0_JPRB
        PDPMEL (JLON, JK)=0.0_JPRB
      ELSEIF (PMFLXR (JLON, JK+1)<0.0_JPRB) THEN
        PMFLXS (JLON, JK+1)=PMFLXS (JLON, JK+1)+PMFLXR (JLON, JK+1)
        PMFLXR (JLON, JK+1)=0.0_JPRB
      ELSEIF (PMFLXS (JLON, JK+1)<0.0_JPRB) THEN
        PMFLXR (JLON, JK+1)=PMFLXR (JLON, JK+1)+PMFLXS (JLON, JK+1)
        PMFLXS (JLON, JK+1)=0.0_JPRB
      ENDIF

    ELSE
      PMFLXR (JLON, JK+1)=0.0_JPRB
      PMFLXS (JLON, JK+1)=0.0_JPRB
      PDMFDP (JLON, JK)=0.0_JPRB
      PDPMEL (JLON, JK)=0.0_JPRB
    ENDIF

  ENDIF

  
ENDDO



ENDSUBROUTINE CUFLXN_SINGLE_COLUMN

