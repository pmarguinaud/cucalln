PROGRAM MAIN

IMPLICIT NONE


INTEGER :: KLEV 
INTEGER :: KIDIA 
INTEGER :: KFDIA 
INTEGER :: KLON

INTEGER :: IDUM
LOGICAL, ALLOCATABLE :: LLGO_ON(:)
REAL(KIND=8), ALLOCATABLE :: ZSUH (:,:)
REAL(KIND=8), ALLOCATABLE :: ZSENH(:,:)
REAL(KIND=8), ALLOCATABLE :: ZPH(:)
REAL(KIND=8), ALLOCATABLE :: ZQOLD(:)
REAL(KIND=8), ALLOCATABLE :: ZMIXF(:)
REAL(KIND=8), ALLOCATABLE :: ZTU(:,:)
REAL(KIND=8), ALLOCATABLE :: ZQU(:,:)
REAL(KIND=8), ALLOCATABLE :: ZZQENH(:,:) 
REAL(KIND=8), ALLOCATABLE :: ZZGEOH(:,:) 
REAL(KIND=8), ALLOCATABLE :: ZZAPH(:,:) 

REAL (KIND=8) :: ZQF
REAL (KIND=8) :: ZSF
REAL (KIND=8) :: ZTMP
REAL (KIND=8) :: ZRCPD
REAL (KIND=8) :: ZMIX 

KIDIA = 6
KFDIA = 6
KLON = 32
KLEV = 15

ALLOCATE (LLGO_ON(KLON))
ALLOCATE (ZSUH (KLON,KLEV))
ALLOCATE (ZSENH(KLON,KLEV+1))
ALLOCATE (ZPH(KLON))
ALLOCATE (ZQOLD(KLON))
ALLOCATE (ZMIXF(KLON))
ALLOCATE (ZTU(KLON,KLEV))
ALLOCATE (ZQU(KLON,KLEV))
ALLOCATE (ZZQENH(KLON,KLEV))
ALLOCATE (ZZGEOH(KLON,KLEV+1))
ALLOCATE (ZZAPH(KLON,KLEV+1))

CALL TEST0 
CALL TEST1 

CONTAINS

SUBROUTINE R
OPEN (77, FILE='fort.77.full', FORM='UNFORMATTED') 
READ (77) IDUM
READ (77) IDUM
READ (77) ZRCPD
READ (77) LLGO_ON(:)
READ (77) ZZGEOH(:,:)
READ (77) ZZQENH(:,:)
READ (77) ZMIXF(:)
READ (77) ZQU(:,:)
READ (77) ZSENH(:,:)
READ (77) ZSUH(:,:)
READ (77) ZZAPH(:,:)
CLOSE (77)
END SUBROUTINE

SUBROUTINE TEST0 

IMPLICIT NONE

INTEGER :: JKK
INTEGER :: JL
INTEGER :: JK


JKK = 14

DO JK=JKK-1,2,-1


   IF(JKK==KLEV.OR.6==KLEV-1) THEN 
      DO JL=KIDIA,KFDIA
       IF (LLGO_ON(JL)) THEN
         ZSUH (JL,JK)= (ZSUH(JL,JK+1)*(1.0_8-ZMIXF(JL))+2.0_8*ZMIXF(JL)*ZSF) * ZTMP  
         ZQOLD(JL)  = ZQU(JL,JK)
         ZTU (JL,JK) = (ZSUH(JL,JK)-ZZGEOH(JL,JK))*ZRCPD
       ENDIF
     ENDDO

   ELSE

     IF (JKK == 14 .AND. JK == 12) THEN
       CALL R
     ENDIF

     DO JL=KIDIA,KFDIA
       IF (LLGO_ON(JL)) THEN
         ZMIXF(JL)=MIN(1.0_8,ZMIXF(JL))
         ZQF = (ZZQENH(JL,JK+1) + ZZQENH(JL,JK))*0.5_8
         ZSF = (ZSENH(JL,JK+1) + ZSENH(JL,JK))*0.5_8
         ZQU(JL,JK)= ZQU(JL,JK+1)*(1.0_8-ZMIXF(JL))+ ZQF*ZMIXF(JL)
         ZSUH(JL,JK)= ZSUH(JL,JK+1)*(1.0_8-ZMIXF(JL))+ ZSF*ZMIXF(JL)
         ZQOLD(JL)  = ZQU(JL,JK)
         ZTU (JL,JK)= (ZSUH(JL,JK)-ZZGEOH(JL,JK))*ZRCPD
         ZPH  (JL)  = ZZAPH(JL,JK)
       ENDIF
     ENDDO

     IF (JKK == 14 .AND. JK == 12) THEN
       WRITE (*, '(" CUBASE 498 ",E30.20)') ZTU(6,JK)
     ENDIF

  ENDIF
  
ENDDO
   

END SUBROUTINE 

SUBROUTINE TEST1 

IMPLICIT NONE

INTEGER ::JKK
INTEGER ::JLON
INTEGER ::JK


JLON = KIDIA


JKK = 14

DO JK=JKK-1, 2,-1

  IF (JKK==KLEV.OR.6==KLEV-1) THEN
    IF (LLGO_ON (JLON)) THEN
      ZSUH (JLON, JK)=(ZSUH (JLON, JK+1)*(1.0_8-ZMIX )+2.0_8*ZMIX *ZSF)*ZTMP
      ZQOLD =ZQU (JLON, JK)
      ZTU (JLON, JK)=(ZSUH (JLON, JK)-ZZGEOH (JLON, JK))*ZRCPD
    ENDIF
  ELSE

    IF (JKK==14.AND.JK==12) THEN
      CALL R
      ZMIX = ZMIXF (6)
    ENDIF

    IF (LLGO_ON (JLON)) THEN
      ZMIX =MIN (1.0_8, ZMIX )
      ZQF=(ZZQENH (JLON, JK+1)+ZZQENH (JLON, JK))*0.5_8
      ZSF=(ZSENH (JLON, JK+1)+ZSENH (JLON, JK))*0.5_8
      ZQU (JLON, JK)=ZQU (JLON, JK+1)*(1.0_8-ZMIX )+ZQF*ZMIX 
      ZSUH (JLON, JK)=ZSUH (JLON, JK+1)*(1.0_8-ZMIX )+ZSF*ZMIX 
      ZQOLD =ZQU (JLON, JK)
      ZTU (JLON, JK)=(ZSUH (JLON, JK)-ZZGEOH (JLON, JK))*ZRCPD
      ZPH (JLON)=ZZAPH (JLON, JK)
    ENDIF

    IF (JKK==14.AND.JK==12) THEN
      WRITE (*,'(" CUBASE 498 ",E30.20)') ZTU (JLON, JK)
    ENDIF

  ENDIF

ENDDO

ENDSUBROUTINE 

END
