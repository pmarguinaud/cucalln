SUBROUTINE CUDUDV_SINGLE_COLUMN (YDCST, YDECUMF, KIDIA, KFDIA, KLON, KLEV, KSPPN2D&
&, KTOPM2, KTYPE, KCBOT, KCTOP, LDCUM, PTSPHY, PAPH, PAP, PUEN, PVEN, PMFU, PMFD&
&, PMFUO, PMFDO, PUU, PUD, PVU, PVD, PGP2DSPP, PTENU, PTENV, YDSTACK)
!$acc routine (CUDUDV_SINGLE_COLUMN) seq
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOECUMF,ONLY:TECUMF
USE SPP_MOD,ONLY:YSPP_CONFIG, YSPP
USE YOMPERTPAR,ONLY:LPERTPAR, LPERT_CUDUV, CUDU_MOD, CUDV_MOD
USE STACK_MOD
#include "stack.h"

IMPLICIT NONE

TYPE (TCST), INTENT (IN)::YDCST
TYPE (TECUMF), INTENT (IN)::YDECUMF
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KSPPN2D
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KTOPM2
INTEGER (KIND=JPIM), INTENT (IN)::KTYPE (KLON)
INTEGER (KIND=JPIM), INTENT (IN)::KCBOT (KLON)
INTEGER (KIND=JPIM), INTENT (IN)::KCTOP (KLON)
LOGICAL, INTENT (IN)::LDCUM (KLON)
REAL (KIND=JPRB), INTENT (IN)::PTSPHY
REAL (KIND=JPRB), INTENT (IN)::PAPH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PMFU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PMFD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PMFUO (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PMFDO (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGP2DSPP (KLON, KSPPN2D)
REAL (KIND=JPRB), INTENT (INOUT)::PTENU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENV (KLON, KLEV)
TYPE(STACK) :: YDSTACK
TYPE(STACK) :: YLSTACK

REAL (KIND=JPRB)::ZADVW 
temp (REAL (KIND=JPRB), ZMFDV, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZMFUV, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZMFDU, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZMFUU, (KLON, KLEV))

INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::IKB
INTEGER (KIND=JPIM)::IM
INTEGER (KIND=JPIM)::IK

INTEGER (KIND=JPIM)::IPCUDV
INTEGER (KIND=JPIM)::IPCUDU

REAL (KIND=JPRB)::ZV
REAL (KIND=JPRB)::ZU
REAL (KIND=JPRB)::ZTSPHY
REAL (KIND=JPRB)::ZIMP
REAL (KIND=JPRB)::ZZP

REAL (KIND=JPRB)::ZLIMN2
REAL (KIND=JPRB)::ZMDV
REAL (KIND=JPRB)::ZMDU

REAL (KIND=JPRB)::ZFAC
REAL (KIND=JPRB)::ZN2
REAL (KIND=JPRB)::ZXV
REAL (KIND=JPRB)::ZXU

REAL (KIND=JPRB)::ZRDV
REAL (KIND=JPRB)::ZRDU

temp (REAL (KIND=JPRB), ZDP, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZDVDT, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZDUDT, (KLON, KLEV))

temp (REAL (KIND=JPRB), ZR2, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZR1, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZB, (KLON, KLEV))
temp (LOGICAL, LLCUMBAS, (KLON, KLEV))

LOGICAL::LLPPAR_CUDUV
LOGICAL::LLPERT_CUDUDV

#include "cubidiag_single_column.intfb.h"

YLSTACK = YDSTACK

alloc (ZMFDV)
alloc (ZMFUV)
alloc (ZMFDU)
alloc (ZMFUU)
alloc (ZDP)
alloc (ZDVDT)
alloc (ZDUDT)
alloc (ZR2)
alloc (ZR1)
alloc (ZB)
alloc (LLCUMBAS)



JLON = KIDIA


ZIMP=1.0_JPRB-YDECUMF%RMFSOLUV
ZTSPHY=1.0_JPRB/PTSPHY

ZADVW =0.0_JPRB

IF (KTYPE (JLON)==1)  THEN
    ZADVW =YDECUMF%RMFADVW
ENDIF



DO JK=1, KLEV

  

  IF (LDCUM (JLON)) THEN
    ZDP (JLON, JK)=YDCST%RG/(PAPH (JLON, JK+1)-PAPH (JLON, JK))
  ENDIF

  
ENDDO


DO JK=KTOPM2, KLEV
  IK=JK-1

  

  IF (LDCUM (JLON)) THEN
    ZMFUU (JLON, JK)=PMFU (JLON, JK)*(PUU (JLON, JK)-ZIMP*PUEN (JLON, IK))
    ZMFUV (JLON, JK)=PMFU (JLON, JK)*(PVU (JLON, JK)-ZIMP*PVEN (JLON, IK))
    ZMFDU (JLON, JK)=PMFD (JLON, JK)*(PUD (JLON, JK)-ZIMP*PUEN (JLON, IK))
    ZMFDV (JLON, JK)=PMFD (JLON, JK)*(PVD (JLON, JK)-ZIMP*PVEN (JLON, IK))
  ENDIF

  
ENDDO


IF (YDECUMF%RMFSOLUV==0.0_JPRB) THEN

  DO JK=KTOPM2, KLEV

    

    IF (LDCUM (JLON).AND.JK>KCBOT (JLON)) THEN
      IKB=KCBOT (JLON)
      ZZP=((PAPH (JLON, KLEV+1)-PAPH (JLON, JK))/(PAPH (JLON, KLEV+1)-PAPH (JLON, IKB)))

      IF (KTYPE (JLON)==3) THEN
        ZZP=ZZP*ZZP
      ENDIF

      ZMFUU (JLON, JK)=ZMFUU (JLON, IKB)*ZZP
      ZMFUV (JLON, JK)=ZMFUV (JLON, IKB)*ZZP
      ZMFDU (JLON, JK)=ZMFDU (JLON, IKB)*ZZP
      ZMFDV (JLON, JK)=ZMFDV (JLON, IKB)*ZZP
    ENDIF

  
  ENDDO

ENDIF


DO JK=KTOPM2, KLEV

  IF (JK<KLEV) THEN
    IK=JK+1

    

    IF (LDCUM (JLON)) THEN
      ZDUDT (JLON, JK)=ZDP (JLON, JK)*(ZMFUU (JLON, IK)-ZMFUU&
      & (JLON, JK)+ZMFDU (JLON, IK)-ZMFDU (JLON, JK))
      ZDVDT (JLON, JK)=ZDP (JLON, JK)*(ZMFUV (JLON, IK)-ZMFUV&
      & (JLON, JK)+ZMFDV (JLON, IK)-ZMFDV (JLON, JK))
    ENDIF

  
  ELSE

    

    IF (LDCUM (JLON)) THEN
      ZDUDT (JLON, JK)=-ZDP (JLON, JK)*(ZMFUU (JLON, JK)+ZMFDU (JLON, JK))
      ZDVDT (JLON, JK)=-ZDP (JLON, JK)*(ZMFUV (JLON, JK)+ZMFDV (JLON, JK))
    ENDIF

  
  ENDIF

ENDDO


IF (YDECUMF%RMFSOLUV==0.0_JPRB) THEN

  DO JK=KTOPM2, KLEV

    

    IF (LDCUM (JLON)) THEN
      PTENU (JLON, JK)=PTENU (JLON, JK)+ZDUDT (JLON, JK)
      PTENV (JLON, JK)=PTENV (JLON, JK)+ZDVDT (JLON, JK)
    ENDIF

  
  ENDDO

ELSE
  LLCUMBAS (JLON,:)=.FALSE.
  ZB (JLON,:)=1.0_JPRB
  ZMFUU (JLON,:)=0.0_JPRB

  DO JK=KTOPM2, KLEV
    IK=JK+1
    IM=JK-1
    
    LLCUMBAS (JLON, JK)=LDCUM (JLON).AND.JK>=KCTOP (JLON)-1

    IF (LLCUMBAS (JLON, JK)) THEN
      ZZP=YDECUMF%RMFSOLUV*ZDP (JLON, JK)*PTSPHY
      ZMFUU (JLON, JK)=-ZZP*(PMFU (JLON, JK)+PMFD (JLON, JK))

      IF (JK<KLEV) THEN
        ZB (JLON, JK)=1.0_JPRB+ZZP*(PMFU (JLON, IK)+PMFD (JLON, IK))
      ELSE
        ZB (JLON, JK)=1.0_JPRB
      ENDIF

      ZZP=YDCST%RG*(PMFUO (JLON, JK)+YDECUMF%RMFADVWDD*PMFDO (JLON&
      &, JK))/(PAP (JLON, JK)-PAP (JLON, IM))*PTSPHY*ZADVW 
      ZU=ZZP*(PUEN (JLON, IM)-PUEN (JLON, JK))
      ZV=ZZP*(PVEN (JLON, IM)-PVEN (JLON, JK))
      ZDUDT (JLON, JK)=(ZDUDT (JLON, JK)+PTENU (JLON, JK)*YDECUMF%RMFSOLRHS)*PTSPHY+PUEN (JLON, JK)-ZU
      ZDVDT (JLON, JK)=(ZDVDT (JLON, JK)+PTENV (JLON, JK)*YDECUMF%RMFSOLRHS)*PTSPHY+PVEN (JLON, JK)-ZV
    ENDIF

  
  ENDDO

  CALL CUBIDIAG_SINGLE_COLUMN (KIDIA, KFDIA, KLON, KLEV, KCTOP&
  &, LLCUMBAS, ZMFUU, ZB, ZDUDT, ZR1, YDSTACK=YLSTACK)
  CALL CUBIDIAG_SINGLE_COLUMN (KIDIA, KFDIA, KLON, KLEV, KCTOP&
  &, LLCUMBAS, ZMFUU, ZB, ZDVDT, ZR2, YDSTACK=YLSTACK)

  

  DO JK=KTOPM2, KLEV

    

    IF (LLCUMBAS (JLON, JK)) THEN

      IF ((LLPERT_CUDUDV).OR.(LLPPAR_CUDUV)) THEN
        PTENU (JLON, JK)=PTENU (JLON, JK)*(1.0_JPRB-YDECUMF%RMFSOLRHS&
        &)+ZRDU *(ZR1 (JLON, JK)-PUEN (JLON, JK))*ZTSPHY
        PTENV (JLON, JK)=PTENV (JLON, JK)*(1.0_JPRB-YDECUMF%RMFSOLRHS&
        &)+ZRDV *(ZR2 (JLON, JK)-PVEN (JLON, JK))*ZTSPHY
      ELSE
        PTENU (JLON, JK)=PTENU (JLON, JK)*(1.0_JPRB-YDECUMF%RMFSOLRHS&
        &)+(ZR1 (JLON, JK)-PUEN (JLON, JK))*ZTSPHY
        PTENV (JLON, JK)=PTENV (JLON, JK)*(1.0_JPRB-YDECUMF%RMFSOLRHS&
        &)+(ZR2 (JLON, JK)-PVEN (JLON, JK))*ZTSPHY
      ENDIF

    ENDIF

  
  ENDDO

ENDIF



ENDSUBROUTINE CUDUDV_SINGLE_COLUMN

